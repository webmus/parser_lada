# parser_lada

## Объяснение распространённой ошибки движка Lada

Если сайт выводит сообщение вида:

```
Fatal error: Uncaught Error: Call to undefined function lada_import_html_fragment()
```

это означает, что в процессе выполнения PHP-скрипта был вызван метод `lada_import_html_fragment()`,
но интерпретатор не нашёл его определения. Как правило, функция определена внутри одного из файлов
ядра системы управления сайтом или в плагине. Ошибка возникает в двух типичных ситуациях:

1. **Отсутствует подключение нужного файла.** Скрипт, который пользуется функцией, должен подключить
   PHP-файл с её определением (через `require`, `include` и т. п.). Если файл не подключён, функция
   остаётся неопределённой.
2. **Файл был удалён или не загружен на сервер.** Даже при корректном подключении функция не появится,
   если физически отсутствует файл, в котором она объявлена.

Чтобы помочь исправить проблему, важно предоставить:

- полный список файлов, относящихся к кастомным или сторонним плагинам, которые используют функцию;
- содержимое файла, где функция должна объявляться (обычно это один из файлов ядра Lada CMS);
- структуру `engine/cache/system/plugins/` и исходный код плагина, который вызывает функцию;
- журналы или историю последних изменений сайта (удаление/обновление плагинов, обновление CMS);
- версию CMS и набор установленных модулей.

Эта информация позволит определить, какой файл обязан объявлять `lada_import_html_fragment()` и
почему он не подключается в текущей конфигурации.

## Диагностика этапов парсинга

Плагин формирует журналы в каталоге `logs/` и теперь, помимо обычных записей, оставляет пометки вида
`[STAGE:...]` для ключевых шагов:

* `LIST_*` — сбор ссылок (`LIST_START`, `LIST_MODULE_START`, `LIST_MODULE_DONE`, `LIST_END`).
* `NEWS_*` — загрузка и подготовка статей из очереди (`NEWS_START`, `NEWS_ITEM_START`, `NEWS_ITEM_DONE`, `NEWS_END`).
* `ADD_*` — добавление новости в базу (`ADD_CALL`, `ADD_BEFORE_INSERT`, `ADD_SUCCESS`, `ADD_SKIPPED`).
* `REWRITE_*` — работа с GPT и обновление материала (`REWRITE_START`, `REWRITE_DONE`).
* `POST_SEND` — автоматическая отправка после публикации.

По времени появления записей легко понять, на каком этапе процесс остановился или завершился с ошибкой.

## План интеграции источника azh.kz

1. **Сбор ссылок (`engine/modules/parse_azh_list.php`)**
   * Подключить `helpers.php`, как это сделано в `parse_tengri_list.php`, и получить страницу `https://azh.kz/ru/news/in-atyrau` через `getPageContent($url)`. При ошибке загрузки сразу возвращать `0` — журнал стадии `LIST_*` ожидает числовой ответ.
   * Извлекать из HTML только содержимое контейнера `<div class="articles">`, затем проходить по вложенным `<article>` и ссылкам `<a class="news-list__item">`. Рекламные вставки расположены вне этого блока и автоматически отфильтруются.
   * Для каждой карточки вытягивать постер (`<span class="news-list__image">` → `<img>`), заголовок (`.news-list__title`), анонс (`.news-list__announce`) и ссылку. Относительные пути конвертировать в абсолютные `https://azh.kz/...`, постер складывать в `$item['poster']` по аналогии с Тенгри.
   * Сохранять ссылку через `$db->safesql`, проверять наличие записи в `{prefix}_post` и добавлять новые позиции в очередь `addToList("azh", $title, $poster, $post_link, $short_story, $category_news, $file)`. Возвращать количество добавленных ссылок, чтобы `parse_list` корректно логировал `LIST_MODULE_DONE`.
   * Фильтровать только актуальные материалы: ориентироваться на подпись `<small>` c «Сегодня» или сравнивать дату с текущей (аналогично проверке `<span>Сегодня</span>` в модуле `parse_tengri_list.php`).

2. **Парсинг полной новости (`engine/modules/parse_azh.php`)**
   * В модуле очереди получать из `$item` сохранённые ссылку, заголовок, постер и анонс (как делает `parse_tengri.php`), загружать HTML новости через `getPageContent($post_link)`.
   * Заголовок в публикации держать синхронно с `<h1>` страницы: при расхождениях обновлять `$title`. Основное изображение брать из первого `<figure><img>` внутри блока статьи; если в списке постер пустой, использовать найденное значение.
   * Основной текст вырезать из `<div class="user-content mb-5" itemprop="articleBody">`, удалять из него `<div id="ad_inside_1">` и другие рекламные/скриптовые блоки по образцу регулярных выражений из `parse_tengri.php` (удаление `<script>`, `<noindex>`, пустых параграфов, лишних ссылок).
   * Собрать массив изображений из контента (по расширениям `.jpg|.jpeg|.png|.gif|.webp|.svg`), подготовить очищенный `$text` и вызвать `addPost($short_story, "azh", "", $title, $text, $poster, $poster, $post_link, $images, $category_news)`.

3. **Проверки и сопровождение**
   * Запустить модуль на нескольких новостях и убедиться, что в логах появляются корректные `LIST_*` и `NEWS_*` отметки, как у Тенгри.
   * Описать особенности фильтрации рекламы и извлечения изображений в комментариях или сопроводительной документации, чтобы поддержка источника соответствовала остальным модулям.

